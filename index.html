<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FixMap AI - –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/maintenance.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/maintenance.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: none; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #3b82f6; box-shadow: 0 0 10px #3b82f6; animation: scan 2s linear infinite; z-index: 10; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        #app-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div id="app-loader">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">–ó–∞–ø—É—Å–∫ FixMap...</h2>
        <p id="error-display" class="text-red-500 text-xs mt-4 px-4 text-center hidden"></p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫
        window.onerror = function(msg, url, line) {
            console.error("Global error:", msg);
            const loader = document.getElementById('app-loader');
            if(loader && loader.style.display !== 'none') {
                const errDiv = document.getElementById('error-display');
                errDiv.style.display = 'block';
                errDiv.innerText = `–û—à–∏–±–∫–∞: ${msg}`;
            }
            return false;
        };

        const { useState, useEffect, useRef } = React;

        // --- –í–ê–® –ö–õ–Æ–ß GEMINI ---
        const apiKey = "AIzaSyAoue6cl9st8fdqZ9N-nHNror7eH_R1RxU"; 

        // --- –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
        let auth = null;
        let db = null;
        let isFirebaseAvailable = false;
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–∏–≥ –æ—Ç Vercel
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (config) {
                if (!firebase.apps.length) firebase.initializeApp(config);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                try {
                    db.settings({ merge: true });
                } catch(err) {
                    console.warn("DB settings warning:", err);
                }
                
                isFirebaseAvailable = true;
            } else {
                console.log("–†–µ–∂–∏–º –î–ï–ú–û: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–æ –ò–ò –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!).");
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ Firebase:", e);
            isFirebaseAvailable = false;
        }

        const appId = 'fixmap-public-demo';

        // --- –£–¢–ò–õ–ò–¢–´ ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
                    if ((encoded.length % 4) > 0) { encoded += '='.repeat(4 - (encoded.length % 4)); }
                    resolve(encoded);
                };
                reader.onerror = error => reject(error);
            });
        };

        // --- –¢–ï–ö–°–¢–´ ---
        const translations = {
            ru: {
                welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                app_subtitle: "–†–µ—à–∞–µ–º –≥–æ—Ä–æ–¥—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                report_btn: "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ",
                feed_title: "–õ–µ–Ω—Ç–∞ –ø—Ä–æ–±–ª–µ–º",
                no_reports: "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!",
                upload_title: "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞",
                take_photo: "–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ",
                gallery_hint: "–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏",
                analyzing: "–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...",
                result_title: "AI –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–í–∞–∂–Ω–æ—Å—Ç—å",
                dept: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
                desc_title: "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                submit_btn: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É",
                chat_title: "–ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–æ–≤–µ—Ç–Ω–∏–∫",
                chat_placeholder: "–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –∑–∞–∫–æ–Ω—ã...",
                demo_warning: "‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º (–ë–µ–∑ –ë–î)",
                solution_title: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ",
                fio_label: "–§–ò–û –ó–∞—è–≤–∏—Ç–µ–ª—è",
                address_label: "–ê–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä",
                geo_btn: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è",
                geo_ok: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã",
                fio_placeholder: "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
                address_placeholder: "—É–ª. –ú–∞–Ω–∞—Å–∞ 45"
            },
            ky: {
                welcome: "–ö–æ—à –∫–µ–ª–∏“£–∏–∑",
                app_subtitle: "–®–∞–∞—Ä–¥—ã–∫ –∫”©–π–≥”©–π–ª”©—Ä–¥“Ø —á–µ—á–µ–±–∏–∑",
                report_btn: "–ö”©–π–≥”©–π–¥“Ø –±–∏–ª–¥–∏—Ä“Ø“Ø",
                feed_title: "–ö”©–π–≥”©–π–ª”©—Ä —Ç“Ø—Ä–º”©–≥“Ø",
                no_reports: "–ê–∑—ã—Ä—ã–Ω—á–∞ –∞—Ä—ã–∑–¥–∞—Ä –∂–æ–∫.",
                upload_title: "–ñ–∞“£—ã –∞—Ä—ã–∑",
                take_photo: "–°“Ø—Ä”©—Ç–∫”© —Ç–∞—Ä—Ç—ã“£—ã–∑",
                gallery_hint: "–ñ–µ –≥–∞–ª–µ—Ä–µ—è–¥–∞–Ω —Ç–∞–Ω–¥–∞“£—ã–∑",
                analyzing: "–°“Ø—Ä”©—Ç—Ç“Ø —Ç–∞–ª–¥–æ–æ...",
                result_title: "AI –¢–∞–ª–¥–æ–æ –¥–∞—è—Ä",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–ú–∞–∞–Ω–∏–ª“Ø“Ø–ª“Ø–≥“Ø",
                dept: "–ñ–æ–æ–ø—Ç—É—É",
                desc_title: "–ö”©–π–≥”©–π–¥“Ø–Ω —Å“Ø—Ä”©—Ç—Ç”©–ª“Ø—à“Ø",
                submit_btn: "–ê—Ä—ã–∑–¥—ã –∂”©–Ω”©—Ç“Ø“Ø",
                chat_title: "–®–∞–∞—Ä–¥—ã–∫ –∫–µ“£–µ—à—á–∏",
                chat_placeholder: "–ú—ã–π–∑–∞–º–¥–∞—Ä –∂”©–Ω“Ø–Ω–¥”© —Å—É—Ä–∞“£—ã–∑...",
                demo_warning: "‚ö†Ô∏è –î–µ–º–æ —Ä–µ–∂–∏–º (–ë–∞–∑–∞—Å—ã–∑)",
                solution_title: "–¢–µ—Ö–Ω–∏–∫–∞–ª—ã–∫ —á–µ—á–∏–º",
                fio_label: "–ê—Ä—ã–∑ —ç—ç—Å–∏",
                address_label: "–î–∞—Ä–µ–∫",
                geo_btn: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è",
                geo_ok: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä —Ç–∞–±—ã–ª–¥—ã",
                fio_placeholder: "–ê—Å–∞–Ω–æ–≤ –ê.",
                address_placeholder: "–ú–∞–Ω–∞—Å –∫”©—á. 45"
            }
        };

        // --- –ò–ò –°–ï–†–í–ò–°–´ ---
        const callGemini = async (payload, endpoint = "generateContent") => {
            if (!apiKey) throw new Error("NO_API_KEY");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:${endpoint}?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Gemini API Error: " + response.statusText);
            return await response.json();
        };

        const analyzeImageWithGemini = async (file, lang) => {
            try {
                const base64Image = await fileToBase64(file);
                const prompt = `–¢—ã - –ò–ò-–∏–Ω–∂–µ–Ω–µ—Ä. –Ø–∑—ã–∫: ${lang === 'ky' ? '–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π' : '–†—É—Å—Å–∫–∏–π'}.
                –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã –ñ–ö–•. 
                –í–ï–†–ù–ò –°–¢–†–û–ì–û JSON –±–µ–∑ markdown (–±–µ–∑ \`\`\`json):
                {
                    "type": "–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã",
                    "category": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                    "dept": "–°–ª—É–∂–±–∞",
                    "severity": "–í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è",
                    "description": "–û–ø–∏—Å–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª)",
                    "safety_tips": "–°–æ–≤–µ—Ç",
                    "consequences": "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
                    "solution": "–†–µ—à–µ–Ω–∏–µ",
                    "icon": "AlertTriangle"
                }`;
                
                const data = await callGemini({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Image } }] }] });
                let text = data.candidates[0].content.parts[0].text;
                // –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown, –µ—Å–ª–∏ –ò–ò –≤—Å—ë-—Ç–∞–∫–∏ –∏—Ö –¥–æ–±–∞–≤–∏—Ç
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (error) {
                console.warn("AI Analysis failed:", error);
                alert("–û—à–∏–±–∫–∞ –ò–ò. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ.");
                // Fallback –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≤–∏—Å–ª–æ
                return {
                    type: "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞",
                    category: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                    dept: "–ú—ç—Ä–∏—è",
                    severity: "–ù–∏–∑–∫–∞—è",
                    description: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ.",
                    safety_tips: "-",
                    consequences: "-",
                    solution: "-",
                    icon: "AlertCircle"
                };
            }
        };

        // --- –ö–û–ú–ü–û–ù–ï–ù–¢ –ò–ö–û–ù–ö–ò ---
        const toPascalCase = (str) => str ? str.replace(/(^\w|-\w)/g, (clear) => clear.replace('-', '').toUpperCase()) : '';

        const Icon = ({ name, size = 20, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                const lucide = window.lucide;
                if (!lucide || !lucide.icons) return;
                const pascalName = toPascalCase(name);
                const iconData = lucide.icons[pascalName] || lucide.icons.AlertTriangle;
                if (iconData) setIconNode(iconData);
            }, [name]);
            
            if (!iconNode) return <span className="w-5 h-5 inline-block bg-gray-200 rounded-full"></span>;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}
                </svg>
            );
        };

        // --- –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        const App = () => {
            const [view, setView] = useState('lang_select');
            const [lang, setLang] = useState('ru');
            const [reports, setReports] = useState([]); 
            
            // –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
            const [selectedFile, setSelectedFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            
            // –ü–æ–ª—è –≤–≤–æ–¥–∞
            const [fio, setFio] = useState('');
            const [manualAddress, setManualAddress] = useState('');
            const [location, setLocation] = useState(null);
            
            // –ß–∞—Ç
            const [showChat, setShowChat] = useState(false);
            const [chatMsg, setChatMsg] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);

            const T = translations[lang];

            useEffect(() => {
                const loader = document.getElementById('app-loader');
                if(loader) loader.style.display = 'none';
                
                if (isFirebaseAvailable && auth) {
                    auth.signInAnonymously().catch(e => console.warn("Auth failed, working offline", e));
                }
            }, []);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
            useEffect(() => {
                if (isFirebaseAvailable && db) {
                     const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').orderBy('createdAt', 'desc').limit(20);
                     const timer = setTimeout(() => { if(reports.length === 0) console.log("Firestore slow..."); }, 3000);
                     const unsub = q.onSnapshot(
                        s => { clearTimeout(timer); setReports(s.docs.map(d => ({id: d.id, ...d.data()}))); }, 
                        err => { clearTimeout(timer); console.log("Firestore error, using local state.", err); }
                    );
                     return () => { clearTimeout(timer); unsub(); };
                }
            }, []);

            const handleFileSelect = async (e) => {
                if (e.target.files?.[0]) {
                    const file = e.target.files[0];
                    setSelectedFile(file);
                    setPreviewUrl(URL.createObjectURL(file));
                    setView('analyzing');
                    
                    await new Promise(r => setTimeout(r, 1000)); // –ö–æ—Å–º–µ—Ç–∏–∫–∞
                    const result = await analyzeImageWithGemini(file, lang);
                    setAiAnalysis(result);
                    setView('result');
                }
            };

            const getLocation = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => setLocation({lat: pos.coords.latitude, lng: pos.coords.longitude}),
                        () => alert("GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
                    );
                } else {
                    alert("GPS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
                }
            }

            const submitReport = async () => {
                const newReport = {
                    ...aiAnalysis,
                    fio: fio || "–ê–Ω–æ–Ω–∏–º",
                    address: manualAddress || "–ù–µ —É–∫–∞–∑–∞–Ω",
                    createdAt: new Date(),
                    status: '–ù–æ–≤–∞—è',
                    id: Date.now().toString()
                };
                
                // –û—Ñ—Ñ–ª–∞–π–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
                setReports([newReport, ...reports]);
                
                // –ü–æ–ø—ã—Ç–∫–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if (isFirebaseAvailable && db) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').add({
                            ...newReport,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) { console.warn("Cloud save failed."); }
                }
                
                // –°–±—Ä–æ—Å
                setFio(''); setManualAddress(''); setLocation(null);
                setView('home');
            };

            const sendChat = async (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;
                const userText = chatInput;
                setChatMsg(prev => [...prev, {role: 'user', text: userText}]);
                setChatInput('');
                setChatLoading(true);
                
                try {
                    const data = await callGemini({ contents: [{ parts: [{ text: `–í–æ–ø—Ä–æ—Å –ø–æ –ñ–ö–• –ö–†: ${userText}` }] }] });
                    const reply = data.candidates[0].content.parts[0].text;
                    setChatMsg(prev => [...prev, {role: 'user', text: userText}, {role: 'ai', text: reply}]);
                } catch(e) {
                    setChatMsg(prev => [...prev, {role: 'ai', text: "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ò–ò."}]);
                }
                setChatLoading(false);
            };

            // –≠–ö–†–ê–ù–´
            if (view === 'lang_select') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-800 p-6 text-white text-center">
                        <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl border border-white/20 shadow-2xl w-full max-w-sm">
                            <Icon name="globe" size={48} className="mx-auto mb-4 text-blue-200" />
                            <h1 className="text-3xl font-bold mb-8">FixMap AI</h1>
                            <button onClick={() => {setLang('ky'); setView('home');}} className="w-full bg-white text-blue-800 font-bold py-4 rounded-xl mb-3 hover:bg-blue-50 transition">–ö—ã—Ä–≥—ã–∑—á–∞ üá∞üá¨</button>
                            <button onClick={() => {setLang('ru'); setView('home');}} className="w-full bg-blue-500/50 border border-white/30 text-white font-bold py-4 rounded-xl hover:bg-blue-500/70 transition">–†—É—Å—Å–∫–∏–π üá∑üá∫</button>
                        </div>
                    </div>
                );
            }

            if (view === 'analyzing') {
                return (
                    <div className="h-screen bg-gray-900 flex flex-col items-center justify-center relative overflow-hidden">
                         {previewUrl && <img src={previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-40 blur-sm" />}
                         <div className="scan-line"></div>
                         <div className="relative z-10 text-center">
                             <div className="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                             <p className="text-white font-bold text-xl">{T.analyzing}</p>
                         </div>
                    </div>
                );
            }

            if (view === 'result' && aiAnalysis) {
                return (
                    <div className="min-h-screen bg-gray-50 pb-8 flex flex-col">
                        <div className="relative h-64 shrink-0 bg-gray-900">
                            <img src={previewUrl} className="w-full h-full object-cover opacity-90" />
                            <button onClick={() => setView('home')} className="absolute top-4 left-4 bg-black/40 p-2 rounded-full text-white backdrop-blur-md"><Icon name="arrow-left"/></button>
                            <div className="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black/80 to-transparent">
                                <span className="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">{T.result_title}</span>
                                <h2 className="text-2xl font-bold text-white">{aiAnalysis.type}</h2>
                            </div>
                        </div>
                        
                        <div className="flex-1 p-6 -mt-6 bg-gray-50 rounded-t-3xl relative z-10 space-y-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="bg-blue-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.category}</div><div className="font-bold text-sm">{aiAnalysis.category}</div></div>
                                    <div className="bg-red-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.severity}</div><div className="font-bold text-sm">{aiAnalysis.severity}</div></div>
                                </div>
                                <div className="mb-3"><div className="text-xs text-gray-400 font-bold uppercase">{T.desc_title}</div><p className="text-sm text-gray-700">{aiAnalysis.description}</p></div>
                            </div>
                            
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block uppercase">{T.fio_label}</label>
                                    <div className="flex items-center bg-gray-50 rounded-xl border px-3 py-1">
                                        <Icon name="user" className="text-gray-400 mr-2" />
                                        <input 
                                            type="text" 
                                            className="w-full bg-transparent p-2 outline-none text-sm" 
                                            placeholder={T.fio_placeholder}
                                            value={fio}
                                            onChange={(e) => setFio(e.target.value)}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block uppercase">{T.address_label}</label>
                                    <div className="flex items-center bg-gray-50 rounded-xl border px-3 py-1">
                                        <Icon name="map-pin" className="text-gray-400 mr-2" />
                                        <input 
                                            type="text" 
                                            className="w-full bg-transparent p-2 outline-none text-sm" 
                                            placeholder={T.address_placeholder}
                                            value={manualAddress}
                                            onChange={(e) => setManualAddress(e.target.value)}
                                        />
                                    </div>
                                </div>
                                <button onClick={getLocation} className={`w-full py-2 rounded-xl border text-sm font-bold flex items-center justify-center gap-2 ${location ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-600'}`}>
                                    <Icon name={location ? "check-circle" : "crosshair"} size={16}/> {location ? T.geo_ok : T.geo_btn}
                                </button>
                            </div>

                            <button onClick={submitReport} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">{T.submit_btn}</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 pb-24 relative">
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-6 rounded-b-[2.5rem] shadow-xl relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2 font-bold text-xl"><span className="bg-white/20 p-1 rounded"><Icon name="sparkles" size={16}/></span> FixMap</div>
                            <button onClick={() => setView('lang_select')} className="text-xs bg-white/20 px-3 py-1 rounded-full">{lang.toUpperCase()}</button>
                        </div>
                        <h1 className="text-3xl font-extrabold mb-2">{T.app_subtitle}</h1>
                        {!isFirebaseAvailable && <p className="text-xs text-yellow-200 bg-yellow-900/30 p-2 rounded inline-block">{T.demo_warning}</p>}
                        
                        <div className="mt-6 flex gap-3">
                             <label className="flex-1 bg-white text-blue-700 font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 cursor-pointer active:scale-95 transition">
                                <Icon name="camera"/> {T.take_photo}
                                <input type="file" accept="image/*" className="hidden" onChange={handleFileSelect} />
                            </label>
                        </div>
                    </div>

                    <div className="p-4 pt-6">
                        <h2 className="font-bold text-gray-800 mb-4 px-2">{T.feed_title}</h2>
                        {reports.length === 0 ? (
                            <div className="text-center text-gray-400 py-10 flex flex-col items-center">
                                <Icon name="inbox" size={48} className="mb-2 opacity-50"/>
                                <p>{T.no_reports}</p>
                            </div>
                        ) : (
                            reports.map(r => (
                                <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3 flex gap-3">
                                    <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shrink-0">
                                        <Icon name={r.icon || "alert-circle"} size={20}/>
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between">
                                            <h3 className="font-bold text-gray-800 text-sm">{r.type}</h3>
                                            <span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500 h-fit">{r.category}</span>
                                        </div>
                                        <p className="text-xs text-gray-500 line-clamp-2 mt-1">{r.description}</p>
                                        <div className="mt-2 flex items-center text-[10px] text-gray-400 gap-2">
                                            {r.fio && <span className="flex items-center gap-1"><Icon name="user" size={10}/> {r.fio}</span>}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <button onClick={() => setShowChat(!showChat)} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition z-50">
                        <Icon name="message-circle" size={28}/>
                    </button>

                    {showChat && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm h-[500px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                                    <h3 className="font-bold">{T.chat_title}</h3>
                                    <button onClick={() => setShowChat(false)}><Icon name="x"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {chatMsg.length === 0 && <p className="text-center text-gray-400 text-sm mt-10">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤!</p>}
                                    {chatMsg.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 rounded-2xl max-w-[80%] text-sm ${m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    {chatLoading && <div className="text-xs text-gray-400 animate-pulse">–ü–µ—á–∞—Ç–∞–µ—Ç...</div>}
                                </div>
                                <form onSubmit={sendChat} className="p-3 border-t flex gap-2">
                                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder={T.chat_placeholder} className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none"/>
                                    <button type="submit" className="bg-blue-600 text-white p-2 rounded-full"><Icon name="send" size={18}/></button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
