<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FixMap AI - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/maintenance.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/maintenance.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: none; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #3b82f6; box-shadow: 0 0 10px #3b82f6; animation: scan 2s linear infinite; z-index: 10; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        #app-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="app-loader">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">–ó–∞–ø—É—Å–∫ FixMap...</h2>
        <p id="error-display" class="text-red-500 text-xs mt-4 px-4 text-center hidden"></p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // Global Error Handler
        window.onerror = function(msg, url, line) {
            console.error("Global error:", msg);
            const loader = document.getElementById('app-loader');
            if(loader && loader.style.display !== 'none') {
                const errDiv = document.getElementById('error-display');
                errDiv.style.display = 'block';
                errDiv.innerText = `–û—à–∏–±–∫–∞: ${msg}`;
            }
            return false;
        };

        const { useState, useEffect, useMemo } = React;

        // --- API CONFIGURATION ---
        const apiKey = "AIzaSyC_-CNAdw0XxXcF8273HFrwvz_tkNvz7pU"; 

        // --- FIREBASE INIT ---
        let auth = null;
        let db = null;
        let isFirebaseAvailable = false;
        
        try {
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (config) {
                if (!firebase.apps.length) firebase.initializeApp(config);
                auth = firebase.auth();
                db = firebase.firestore();
                try { db.settings({ merge: true }); } catch(err) { console.warn("DB settings warning:", err); }
                isFirebaseAvailable = true;
            }
        } catch (e) {
            console.error("Firebase error:", e);
            isFirebaseAvailable = false;
        }

        const appId = 'fixmap-public-demo-v2';

        // --- UTILS ---
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
                if ((encoded.length % 4) > 0) { encoded += '='.repeat(4 - (encoded.length % 4)); }
                resolve(encoded);
            };
            reader.onerror = error => reject(error);
        });

        const formatDate = (dateInput) => {
            if (!dateInput) return "–ù–µ–¥–∞–≤–Ω–æ";
            // Handle Firestore Timestamp or standard Date
            const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
            return new Intl.DateTimeFormat('ru-RU', { 
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
            }).format(date);
        };

        // --- TRANSLATIONS ---
        const translations = {
            ru: {
                welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
                app_subtitle: "–†–µ—à–∞–µ–º –≥–æ—Ä–æ–¥—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                report_btn: "–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ",
                feed_title: "–õ–µ–Ω—Ç–∞ –ø—Ä–æ–±–ª–µ–º",
                no_reports: "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!",
                upload_title: "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞",
                take_photo: "–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ",
                gallery_hint: "–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏",
                analyzing: "–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...",
                result_title: "AI –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–í–∞–∂–Ω–æ—Å—Ç—å",
                dept: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
                desc_title: "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                submit_btn: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É",
                chat_title: "–ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–æ–≤–µ—Ç–Ω–∏–∫",
                chat_placeholder: "–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –∑–∞–∫–æ–Ω—ã...",
                demo_warning: "‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º",
                fio_label: "–§–ò–û –ó–∞—è–≤–∏—Ç–µ–ª—è",
                address_label: "–ê–¥—Ä–µ—Å –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä",
                geo_btn: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è",
                geo_ok: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã",
                admin_login: "–í—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
                admin_panel: "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ú—ç—Ä–∏–∏",
                login_title: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
                login_btn: "–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É",
                logout: "–í—ã–π—Ç–∏",
                filter_all: "–í—Å–µ –∑–∞—è–≤–∫–∏",
                filter_new: "–ù–æ–≤—ã–µ",
                filter_work: "–í —Ä–∞–±–æ—Ç–µ",
                filter_done: "–†–µ—à–µ–Ω–æ",
                status_change: "–°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:",
                stats_total: "–í—Å–µ–≥–æ",
                stats_new: "–ù–æ–≤—ã—Ö",
                stats_done: "–†–µ—à–µ–Ω–æ"
            },
            ky: {
                welcome: "–ö–æ—à –∫–µ–ª–∏“£–∏–∑",
                app_subtitle: "–®–∞–∞—Ä–¥—ã–∫ –∫”©–π–≥”©–π–ª”©—Ä–¥“Ø —á–µ—á–µ–±–∏–∑",
                report_btn: "–ö”©–π–≥”©–π–¥“Ø –±–∏–ª–¥–∏—Ä“Ø“Ø",
                feed_title: "–ö”©–π–≥”©–π–ª”©—Ä —Ç“Ø—Ä–º”©–≥“Ø",
                no_reports: "–ê–∑—ã—Ä—ã–Ω—á–∞ –∞—Ä—ã–∑–¥–∞—Ä –∂–æ–∫.",
                upload_title: "–ñ–∞“£—ã –∞—Ä—ã–∑",
                take_photo: "–°“Ø—Ä”©—Ç–∫”© —Ç–∞—Ä—Ç—ã“£—ã–∑",
                gallery_hint: "–ñ–µ –≥–∞–ª–µ—Ä–µ—è–¥–∞–Ω —Ç–∞–Ω–¥–∞“£—ã–∑",
                analyzing: "–°“Ø—Ä”©—Ç—Ç“Ø —Ç–∞–ª–¥–æ–æ...",
                result_title: "AI –¢–∞–ª–¥–æ–æ –¥–∞—è—Ä",
                category: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                severity: "–ú–∞–∞–Ω–∏–ª“Ø“Ø–ª“Ø–≥“Ø",
                dept: "–ñ–æ–æ–ø—Ç—É—É",
                desc_title: "–ö”©–π–≥”©–π–¥“Ø–Ω —Å“Ø—Ä”©—Ç—Ç”©–ª“Ø—à“Ø",
                submit_btn: "–ê—Ä—ã–∑–¥—ã –∂”©–Ω”©—Ç“Ø“Ø",
                chat_title: "–®–∞–∞—Ä–¥—ã–∫ –∫–µ“£–µ—à—á–∏",
                chat_placeholder: "–ú—ã–π–∑–∞–º–¥–∞—Ä –∂”©–Ω“Ø–Ω–¥”© —Å—É—Ä–∞“£—ã–∑...",
                demo_warning: "‚ö†Ô∏è –î–µ–º–æ —Ä–µ–∂–∏–º",
                fio_label: "–ê—Ä—ã–∑ —ç—ç—Å–∏",
                address_label: "–î–∞—Ä–µ–∫",
                geo_btn: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è",
                geo_ok: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä —Ç–∞–±—ã–ª–¥—ã",
                admin_login: "–ö—ã–∑–º–∞—Ç–∫–µ—Ä–ª–µ—Ä “Ø—á“Ø–Ω –∫–∏—Ä“Ø“Ø",
                admin_panel: "–ú—ç—Ä–∏—è–Ω—ã–Ω –±–∞—à–∫–∞—Ä—É—É –ø–∞–Ω–µ–ª–∏",
                login_title: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
                login_btn: "–ö–∏—Ä“Ø“Ø",
                logout: "–ß—ã–≥—É—É",
                filter_all: "–ë–∞–∞—Ä—ã",
                filter_new: "–ñ–∞“£—ã",
                filter_work: "–ò—à—Ç–µ",
                filter_done: "–ë“Ø—Ç—Ç“Ø",
                status_change: "–°—Ç–∞—Ç—É—Å—Ç—É ”©–∑–≥”©—Ä—Ç“Ø“Ø:",
                stats_total: "–ñ–∞–ª–ø—ã",
                stats_new: "–ñ–∞“£—ã",
                stats_done: "–ë“Ø—Ç—Ç“Ø"
            }
        };

        // --- GEMINI SERVICE ---
        const callGemini = async (payload, endpoint = "generateContent") => {
            if (!apiKey) throw new Error("NO_API_KEY");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:${endpoint}?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("API Error");
            return await response.json();
        };

        const analyzeImageWithGemini = async (file, lang) => {
            try {
                const base64Image = await fileToBase64(file);
                const prompt = `–¢—ã - –ò–ò-–∏–Ω–∂–µ–Ω–µ—Ä. –Ø–∑—ã–∫: ${lang === 'ky' ? '–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π' : '–†—É—Å—Å–∫–∏–π'}.
                –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã –ñ–ö–•. –í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ JSON:
                {
                    "type": "–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã",
                    "category": "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                    "dept": "–°–ª—É–∂–±–∞",
                    "severity": "–í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è",
                    "description": "–û–ø–∏—Å–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª)"
                }`;
                const data = await callGemini({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Image } }] }] });
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (error) {
                console.warn("AI fail:", error);
                return {
                    type: "–ü—Ä–æ–±–ª–µ–º–∞ (–î–µ–º–æ)",
                    category: "–†–∞–∑–Ω–æ–µ",
                    dept: "–ú—ç—Ä–∏—è",
                    severity: "–°—Ä–µ–¥–Ω—è—è",
                    description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–µ —É–¥–∞–ª—Å—è."
                };
            }
        };

        // --- ICON COMPONENT ---
        const toPascalCase = (str) => str ? str.replace(/(^\w|-\w)/g, (c) => c.replace('-', '').toUpperCase()) : '';
        const Icon = ({ name, size = 20, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                const lucide = window.lucide;
                if (!lucide || !lucide.icons) return;
                const iconData = lucide.icons[toPascalCase(name)] || lucide.icons.AlertCircle;
                setIconNode(iconData);
            }, [name]);
            if (!iconNode) return <span className="w-5 h-5 block bg-gray-200 rounded"></span>;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}
                </svg>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('lang_select');
            const [lang, setLang] = useState('ru');
            const [reports, setReports] = useState([]); 
            
            // New Report State
            const [selectedFile, setSelectedFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [fio, setFio] = useState('');
            const [manualAddress, setManualAddress] = useState('');
            const [location, setLocation] = useState(null);
            
            // Chat State
            const [showChat, setShowChat] = useState(false);
            const [chatMsg, setChatMsg] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);

            // Admin State
            const [adminEmail, setAdminEmail] = useState('');
            const [adminPass, setAdminPass] = useState('');
            const [filterStatus, setFilterStatus] = useState('all'); // all, new, work, done

            const T = translations[lang];

            useEffect(() => {
                document.getElementById('app-loader').style.display = 'none';
                if (isFirebaseAvailable && auth) auth.signInAnonymously().catch(console.warn);
            }, []);

            // Reports Listener
            useEffect(() => {
                if (isFirebaseAvailable && db) {
                     const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').orderBy('createdAt', 'desc').limit(50);
                     const unsub = q.onSnapshot(
                        s => setReports(s.docs.map(d => ({id: d.id, ...d.data()}))), 
                        err => console.log("Offline mode active")
                    );
                     return () => unsub();
                }
            }, []);

            // --- ACTIONS ---
            const handleFileSelect = async (e) => {
                if (e.target.files?.[0]) {
                    const file = e.target.files[0];
                    setSelectedFile(file);
                    setPreviewUrl(URL.createObjectURL(file));
                    setView('analyzing');
                    await new Promise(r => setTimeout(r, 1000));
                    const result = await analyzeImageWithGemini(file, lang);
                    setAiAnalysis(result);
                    setView('result');
                }
            };

            const getLocation = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => setLocation({lat: pos.coords.latitude, lng: pos.coords.longitude}),
                        () => alert("GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
                    );
                } else alert("–ù–µ—Ç GPS");
            };

            const submitReport = async () => {
                const newReport = {
                    ...aiAnalysis,
                    fio: fio || "–ê–Ω–æ–Ω–∏–º",
                    address: manualAddress || "–ù–µ —É–∫–∞–∑–∞–Ω",
                    location: location,
                    createdAt: new Date(),
                    status: '–ù–æ–≤–∞—è', // New, In Progress (–í —Ä–∞–±–æ—Ç–µ), Done (–†–µ—à–µ–Ω–æ)
                    id: Date.now().toString()
                };
                
                setReports([newReport, ...reports]); // Optimistic update
                
                if (isFirebaseAvailable && db) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').add({
                            ...newReport,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) {}
                }
                setFio(''); setManualAddress(''); setLocation(null); setAiAnalysis(null);
                setView('home');
            };

            const sendChat = async (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;
                const userText = chatInput;
                setChatMsg(prev => [...prev, {role: 'user', text: userText}]);
                setChatInput('');
                setChatLoading(true);
                try {
                    const data = await callGemini({ contents: [{ parts: [{ text: userText }] }] });
                    setChatMsg(prev => [...prev, {role: 'user', text: userText}, {role: 'ai', text: data.candidates[0].content.parts[0].text}]);
                } catch(e) {
                    setChatMsg(prev => [...prev, {role: 'ai', text: "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏."}]);
                }
                setChatLoading(false);
            };

            // --- ADMIN ACTIONS ---
            const handleAdminLogin = () => {
                if (adminEmail === 'admin@gov.kg' && adminPass === '123') {
                    setView('admin_dashboard');
                    setAdminEmail(''); setAdminPass('');
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                }
            };

            const updateStatus = async (reportId, newStatus) => {
                // Local update
                setReports(reports.map(r => r.id === reportId ? {...r, status: newStatus} : r));
                
                // Cloud update
                if (isFirebaseAvailable && db) {
                    try {
                        const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('reports').doc(reportId);
                        // Try update, if ID is from local array it might fail in Firestore if not synced yet, which is fine for demo
                        await ref.update({ status: newStatus }); 
                    } catch(e) { console.log("Status update local only"); }
                }
            };

            // Filter reports for admin
            const filteredReports = useMemo(() => {
                if (filterStatus === 'all') return reports;
                if (filterStatus === 'new') return reports.filter(r => r.status === '–ù–æ–≤–∞—è');
                if (filterStatus === 'work') return reports.filter(r => r.status === '–í —Ä–∞–±–æ—Ç–µ');
                if (filterStatus === 'done') return reports.filter(r => r.status === '–†–µ—à–µ–Ω–æ');
                return reports;
            }, [reports, filterStatus]);

            const stats = useMemo(() => ({
                total: reports.length,
                new: reports.filter(r => r.status === '–ù–æ–≤–∞—è').length,
                done: reports.filter(r => r.status === '–†–µ—à–µ–Ω–æ').length
            }), [reports]);


            // --- VIEWS ---
            if (view === 'lang_select') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-800 p-6 text-white text-center relative">
                        <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl border border-white/20 shadow-2xl w-full max-w-sm">
                            <Icon name="globe" size={48} className="mx-auto mb-4 text-blue-200" />
                            <h1 className="text-3xl font-bold mb-8">FixMap AI</h1>
                            <button onClick={() => {setLang('ky'); setView('home');}} className="w-full bg-white text-blue-800 font-bold py-4 rounded-xl mb-3 hover:bg-blue-50 transition">–ö—ã—Ä–≥—ã–∑—á–∞ üá∞üá¨</button>
                            <button onClick={() => {setLang('ru'); setView('home');}} className="w-full bg-blue-500/50 border border-white/30 text-white font-bold py-4 rounded-xl hover:bg-blue-500/70 transition">–†—É—Å—Å–∫–∏–π üá∑üá∫</button>
                        </div>
                        <button onClick={() => setView('admin_login')} className="absolute bottom-8 text-blue-200 text-sm opacity-60 hover:opacity-100 flex items-center gap-2">
                            <Icon name="shield" size={14}/> {T.admin_login}
                        </button>
                    </div>
                );
            }

            if (view === 'admin_login') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-6">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-gray-800">{T.login_title}</h2>
                                <button onClick={() => setView('lang_select')}><Icon name="x" className="text-gray-400"/></button>
                            </div>
                            <input value={adminEmail} onChange={e => setAdminEmail(e.target.value)} placeholder="Email (admin@gov.kg)" className="w-full bg-gray-50 border p-3 rounded-xl mb-3 outline-none"/>
                            <input value={adminPass} onChange={e => setAdminPass(e.target.value)} type="password" placeholder="Password (123)" className="w-full bg-gray-50 border p-3 rounded-xl mb-6 outline-none"/>
                            <button onClick={handleAdminLogin} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">{T.login_btn}</button>
                        </div>
                    </div>
                );
            }

            if (view === 'admin_dashboard') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col">
                        <div className="bg-white border-b p-4 sticky top-0 z-20 shadow-sm flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 text-white p-1.5 rounded"><Icon name="layout-dashboard" size={20}/></div>
                                <h2 className="font-bold text-gray-800 text-sm leading-tight">{T.admin_panel}</h2>
                            </div>
                            <button onClick={() => setView('lang_select')} className="text-red-500 text-xs font-bold px-3 py-1 bg-red-50 rounded-lg">{T.logout}</button>
                        </div>
                        
                        <div className="p-4 flex gap-2 overflow-x-auto">
                            <div className="bg-white p-3 rounded-xl border flex-1 min-w-[100px] shadow-sm">
                                <div className="text-xs text-gray-500 mb-1">{T.stats_total}</div>
                                <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
                            </div>
                            <div className="bg-white p-3 rounded-xl border flex-1 min-w-[100px] shadow-sm">
                                <div className="text-xs text-gray-500 mb-1">{T.stats_new}</div>
                                <div className="text-2xl font-bold text-orange-500">{stats.new}</div>
                            </div>
                            <div className="bg-white p-3 rounded-xl border flex-1 min-w-[100px] shadow-sm">
                                <div className="text-xs text-gray-500 mb-1">{T.stats_done}</div>
                                <div className="text-2xl font-bold text-green-600">{stats.done}</div>
                            </div>
                        </div>

                        <div className="px-4 pb-2 flex gap-2 overflow-x-auto no-scrollbar">
                            {[
                                {k: 'all', l: T.filter_all}, 
                                {k: 'new', l: T.filter_new}, 
                                {k: 'work', l: T.filter_work}, 
                                {k: 'done', l: T.filter_done}
                            ].map(f => (
                                <button key={f.k} onClick={() => setFilterStatus(f.k)} 
                                    className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filterStatus === f.k ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}>
                                    {f.l}
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 p-4 space-y-3 overflow-y-auto">
                            {filteredReports.map(r => (
                                <div key={r.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex gap-2">
                                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                                                r.status === '–ù–æ–≤–∞—è' ? 'bg-orange-100 text-orange-700' :
                                                r.status === '–í —Ä–∞–±–æ—Ç–µ' ? 'bg-blue-100 text-blue-700' :
                                                'bg-green-100 text-green-700'
                                            }`}>{r.status}</span>
                                            <span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded">{formatDate(r.createdAt)}</span>
                                        </div>
                                        <div className="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded">{r.severity}</div>
                                    </div>
                                    
                                    <h3 className="font-bold text-gray-800">{r.type}</h3>
                                    <p className="text-xs text-gray-600 mt-1 mb-3">{r.description}</p>
                                    
                                    <div className="bg-gray-50 rounded-lg p-2 mb-3 space-y-1">
                                        <div className="flex items-center gap-2 text-xs text-gray-700">
                                            <Icon name="user" size={12} className="text-blue-500"/>
                                            <span className="font-medium">{r.fio}</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-gray-700">
                                            <Icon name="map-pin" size={12} className="text-red-500"/>
                                            <span className="font-medium">{r.address}</span>
                                        </div>
                                        {r.location && (
                                            <a href={`https://www.google.com/maps?q=${r.location.lat},${r.location.lng}`} target="_blank" className="text-[10px] text-blue-500 hover:underline flex items-center gap-1 mt-1 pl-5">
                                                –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ <Icon name="external-link" size={10}/>
                                            </a>
                                        )}
                                    </div>

                                    <div className="flex gap-2 pt-2 border-t">
                                        <button onClick={() => updateStatus(r.id, '–í —Ä–∞–±–æ—Ç–µ')} className="flex-1 bg-blue-50 text-blue-700 py-2 rounded-lg text-xs font-bold hover:bg-blue-100">–í —Ä–∞–±–æ—Ç—É</button>
                                        <button onClick={() => updateStatus(r.id, '–†–µ—à–µ–Ω–æ')} className="flex-1 bg-green-50 text-green-700 py-2 rounded-lg text-xs font-bold hover:bg-green-100">–†–µ—à–µ–Ω–æ</button>
                                    </div>
                                </div>
                            ))}
                            {filteredReports.length === 0 && <div className="text-center text-gray-400 py-10">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>}
                        </div>
                    </div>
                );
            }

            if (view === 'analyzing') {
                return (
                    <div className="h-screen bg-gray-900 flex flex-col items-center justify-center relative overflow-hidden">
                         {previewUrl && <img src={previewUrl} className="absolute inset-0 w-full h-full object-cover opacity-40 blur-sm" />}
                         <div className="scan-line"></div>
                         <div className="relative z-10 text-center">
                             <div className="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                             <p className="text-white font-bold text-xl">{T.analyzing}</p>
                         </div>
                    </div>
                );
            }

            if (view === 'result' && aiAnalysis) {
                return (
                    <div className="min-h-screen bg-gray-50 pb-8 flex flex-col">
                        <div className="relative h-64 shrink-0 bg-gray-900">
                            <img src={previewUrl} className="w-full h-full object-cover opacity-90" />
                            <button onClick={() => setView('home')} className="absolute top-4 left-4 bg-black/40 p-2 rounded-full text-white backdrop-blur-md"><Icon name="arrow-left"/></button>
                            <div className="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black/80 to-transparent">
                                <span className="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">{T.result_title}</span>
                                <h2 className="text-2xl font-bold text-white">{aiAnalysis.type}</h2>
                            </div>
                        </div>
                        <div className="flex-1 p-6 -mt-6 bg-gray-50 rounded-t-3xl relative z-10 space-y-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="bg-blue-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.category}</div><div className="font-bold text-sm">{aiAnalysis.category}</div></div>
                                    <div className="bg-red-50 p-3 rounded-xl"><div className="text-xs text-gray-500">{T.severity}</div><div className="font-bold text-sm">{aiAnalysis.severity}</div></div>
                                </div>
                                <div className="mb-3"><div className="text-xs text-gray-400 font-bold uppercase">{T.desc_title}</div><p className="text-sm text-gray-700">{aiAnalysis.description}</p></div>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block uppercase">{T.fio_label}</label>
                                    <div className="flex items-center bg-gray-50 rounded-xl border px-3 py-1">
                                        <Icon name="user" className="text-gray-400 mr-2" />
                                        <input type="text" className="w-full bg-transparent p-2 outline-none text-sm" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." value={fio} onChange={(e) => setFio(e.target.value)}/>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block uppercase">{T.address_label}</label>
                                    <div className="flex items-center bg-gray-50 rounded-xl border px-3 py-1">
                                        <Icon name="map-pin" className="text-gray-400 mr-2" />
                                        <input type="text" className="w-full bg-transparent p-2 outline-none text-sm" placeholder="—É–ª. –ú–∞–Ω–∞—Å–∞ 45" value={manualAddress} onChange={(e) => setManualAddress(e.target.value)}/>
                                    </div>
                                </div>
                                <button onClick={getLocation} className={`w-full py-2 rounded-xl border text-sm font-bold flex items-center justify-center gap-2 ${location ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-600'}`}>
                                    <Icon name={location ? "check-circle" : "crosshair"} size={16}/> {location ? T.geo_ok : T.geo_btn}
                                </button>
                            </div>
                            <button onClick={submitReport} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">{T.submit_btn}</button>
                        </div>
                    </div>
                );
            }

            // HOME
            return (
                <div className="min-h-screen bg-gray-50 pb-24 relative">
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-6 rounded-b-[2.5rem] shadow-xl relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2 font-bold text-xl"><span className="bg-white/20 p-1 rounded"><Icon name="sparkles" size={16}/></span> FixMap</div>
                            <button onClick={() => setView('lang_select')} className="text-xs bg-white/20 px-3 py-1 rounded-full">{lang.toUpperCase()}</button>
                        </div>
                        <h1 className="text-3xl font-extrabold mb-2">{T.app_subtitle}</h1>
                        <div className="mt-6 flex gap-3">
                             <label className="flex-1 bg-white text-blue-700 font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 cursor-pointer active:scale-95 transition">
                                <Icon name="camera"/> {T.take_photo}
                                <input type="file" accept="image/*" className="hidden" onChange={handleFileSelect} />
                            </label>
                        </div>
                    </div>
                    <div className="p-4 pt-6">
                        <h2 className="font-bold text-gray-800 mb-4 px-2">{T.feed_title}</h2>
                        {reports.length === 0 ? (
                            <div className="text-center text-gray-400 py-10 flex flex-col items-center">
                                <Icon name="inbox" size={48} className="mb-2 opacity-50"/>
                                <p>{T.no_reports}</p>
                            </div>
                        ) : (
                            reports.map(r => (
                                <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3 flex gap-3">
                                    <div className="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shrink-0">
                                        <Icon name={r.icon || "alert-circle"} size={20}/>
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between">
                                            <h3 className="font-bold text-gray-800 text-sm">{r.type}</h3>
                                            <span className={`text-[10px] px-2 py-0.5 rounded h-fit ${r.status === '–†–µ—à–µ–Ω–æ' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{r.status}</span>
                                        </div>
                                        <p className="text-xs text-gray-500 line-clamp-2 mt-1">{r.description}</p>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    <button onClick={() => setShowChat(!showChat)} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition z-50">
                        <Icon name="message-circle" size={28}/>
                    </button>
                    {showChat && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm h-[500px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                                    <h3 className="font-bold">{T.chat_title}</h3>
                                    <button onClick={() => setShowChat(false)}><Icon name="x"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {chatMsg.length === 0 && <p className="text-center text-gray-400 text-sm mt-10">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤!</p>}
                                    {chatMsg.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 rounded-2xl max-w-[80%] text-sm ${m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'}`}>{m.text}</div>
                                        </div>
                                    ))}
                                    {chatLoading && <div className="text-xs text-gray-400 animate-pulse">–ü–µ—á–∞—Ç–∞–µ—Ç...</div>}
                                </div>
                                <form onSubmit={sendChat} className="p-3 border-t flex gap-2">
                                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder={T.chat_placeholder} className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none"/>
                                    <button type="submit" className="bg-blue-600 text-white p-2 rounded-full"><Icon name="send" size={18}/></button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
